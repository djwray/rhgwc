<SCRIPT LANGUAGE="JavaScript">
<!--
var originalUrl="http://i.loveruby.net/ja/rhg/book/security.html";
var originalLp ="JAEN";
var originalDis="";
if (self.parent.excite_header.display) {
self.parent.excite_header.display.wb_url.value = originalUrl;
self.parent.excite_header.display.wb_lp.value = originalLp;
}
//-->
</SCRIPT>
<SCRIPT LANGUAGE="JavaScript">
<!--
if (top.excite_header)
{
// ok
}
else
{
top.location.href = "http://www.excite-webtl.jp/world/english/web/?wb_url=http%3A%2F%2Fi.loveruby.net%2Fja%2Frhg%2Fbook%2Fsecurity.html&wb_lp=JAEN&wb_dis=";
}
//-->
</SCRIPT>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP"> <head><base href=http://i.loveruby.net/ja/rhg/book/security.html> <meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS"> <meta http-equiv="Content-Language" content="ja-JP"> <link rel="stylesheet" type="text/css" href="rhg.css"> <link rev="made" href="mailto:aamine@loveruby.net"> <title>Chapter 7 Security</title></head> <body> <h1>Chapter 7 Security</h1> <h3>Principle</h3> <p>It is not a story of the password or the encryption even if it is said security. The security function of Ruby exists to treat "It is not possible to trust it" the one in the environment like CGI program. </p> <p>For instance, the character string when you want to convert the character string that expresses the numerical value into the integer easily There is a method of doing <code>eval</code>. However, <code>eval</code> is a method "The character string Execute it as Ruby program", and the character string received from the person whom someone of where doesn't understand on the network either is done in <code>eval</code>, and it is very dangerous. However, the programmer manages this in detail, this is safe, and it is very [shindoi] . danger ÅcÅc and to divide in this. [Mendoi] .Therefore, it makes a mistake surely some time. Therefore, it is a prearranged performances way in the language that this. ..saying.. It is division. </p> <p>Then, how is Ruby defended from the danger?It says roughly to the cause of the opening the perilous operation not intended ,for instance, of the file and there are two kinds. </p> <ul> <li>Dangerous value</li> <li>Dangerous program</li> </ul> <p>(Comparatively) The program that treats the value : in what I surely wrote in the former It is safe. The code of the program cannot be trusted in the latter quite. </p> <p>Because measures are considerably different in these two causes, it is necessary to divide the level. This is called a security level. It goes out as a global variable named <code>$SAFE</code> at the Ruby level. There is a value from the lowest 0 to the highest 4. It is never lowered when the level goes up by substituting it for the variable, and it raises it once. Because and, operation is limited respectively</p> <p>Level 1 and 3 are abbreviated. Level 0 is a usual program environment. The security system doesn't work at all. Level 2 deals with a dangerous value. It deals with a dangerous program in level 4. 0 assumes it is good, and will see the mechanism of 2 and 4 in detail. </p> <h4>Level 2</h4> <p>Level to deal with dangerous value. Usual CGI etc.</p> <p>It is a pollution mark that does a level 2 base memorized in each object. The pollution mark is put to all objects read from the outside, and when it tries to wear the polluted object in <code>eval</code> and <code>File.open</code> is done, it stops it by generating the exception. </p> <p>It and the pollution mark do "Infection". For instance, when a part of the character string that pollutes it is taken, it has been still polluted. </p> <h4>Level 4</h4> <p>Level to deal with dangerous program. Execution of program brought from the outside (It cannot know the feature) etc.</p> <p>It becomes a prohibition object in level 2 only because of the operation when becoming level 4 because it checked it by both the operation and the value used for it. For instance, change in <code>exit</code>, file I/O, thread operation, and method definition etc.The operation basically becomes a standard though pollution information is somewhat used of course. </p> <h4>Unit of security</h4> <p>The thread of <code>$SAFE</code> is actually local though wanting to see is a global variable. In a word, The security system of Ruby works in each thread. Java. Ruby is not done there though the authority ..each component (object).. can be set when it is NET. It is because the assumed main target is CGI. </p> <p>Therefore, it makes to another thread and the level is separated in the case that only a part of the program wants to raise the security level. Because those who make it about the thread have not explained yet, it endures for the time being only by the following examples and I want it. </p> <pre class="emlist">
# The security level is raised by another thread. P($SAFE) # default is 0. It ..thread according to #.. starts. $SAFE = 4 # level is raised eval(str) Dangerous # program is executed. }
P($SAFE) Like level 0 outside # block
</pre> <h4>Reliability of <code>$SAFE</code></h4> <p>Finally, all the operations of the infection of the pollution mark are done by the hand work though it prohibits. If neither the entire built-in library nor the enhancing library used in a word deal without the omission, pollution becomes interrupted on the way, and it becomes not safe. And, such a hole is actually reported well. Therefore, the author has not trusted it so much for the time being. </p> <p>However, it is not of course because all Ruby programs are however dangerous. A safe program can be written also with <code>$SAFE=0</code>, and the program that can do favor [hanadai] also with <code>$SAFE=4</code> can be written. However, <code>$SAFE</code> (Still) cannot be only overconfident. </p> <p>To begin with, "Active function addition" and "Security" won't coexist. If the new features included adds fast, it is common sense that it it becoming easy to open the hole in proportion to it. Then, it should be thought that <code>ruby</code> might be also naturally dangerous. </p> <h3>Mounting</h3> <p>It is necessary to see "Where is checked?" from the mechanism to catch the security system of <code>ruby</code> completely though mounting from here starts. However, the page to which it is done this time is not, and is not interesting only to list separately. Then, it will be finished that this chapter explains only the mechanism being used for the security check for the time being. API for the check is chiefly two of the following. </p> <ul> <li>The level If it is n or more, it is <code>rb_secure that generates exception <code>SecurityError</code>. (n)</code></li> <li><code>SafeStringValue that generates exception if character string has been polluted more than level 1()</code></li> </ul> <p> <code>SafeStringValue()</code> is not read here. </p> <h4>Pollution mark</h4> <p>It is a macro named <code>OBJ_INFECT()</code> that infects it with <code>basic ..pollution mark.. concrete-&gt; flags</code> with memorized flag <code>FL_TAINT</code>. It uses it like this. </p> <pre class="emlist">
OBJ_TAINT(obj) /* FL_TAINT is put up to obj OBJ_TAINTED(obj) /* */ that examines whether FL_TAINT has adhered to obj OBJ_INFECT(dest, src) /* */ It is infected with dest of FL_TAINT from src */. </pre> <p> <code>OBJ_TAINT()</code> <code>OBJ_TAINTED()</code> assumes it is trivial, and will see only <code>OBJ_INFECT()</code> quickly. </p> <p class="caption">- <code>OBJ_INFECT</code></p> <pre class="longlist">
441 #define OBJ_INFECT(x,s) do { \ if (FL_ABLE(x) &amp;&amp; FL_ABLE(s)) \ RBASIC(x)-&gt;flags | = RBASIC(s)-&gt;flags &amp; FL_TAINT; \ } while (0) (ruby.h)
</pre> <p> <code>FL_ABLE()</code> is whether <code>VALUE</code> of the argument is a pointer is examined. It ..flag.. spreads if both objects are pointers (If in a word, there is <code>flags</code> member). </p> <h4><code>$SAFE</code></h4> <p class="caption">- <code>ruby_safe_level</code></p> <pre class="longlist">
124 int ruby_safe_level = 0; 7401 static void 7402 safe_setter(val) 7403 VALUE val; 7404 { 7405 int level = NUM2INT(val); 7406 7407 if (level &lt; ruby_safe_level) { 7408 rb_raise(rb_eSecurityError, "tried to downgrade safe level from %d to %d", 7409 ruby_safe_level, level); 7410 } 7411 ruby_safe_level = level; 7412 curr_thread-&gt;safe = level; 7413 } (eval.c)
</pre> <p>The substance of <code>$SAFE</code> is <code>ruby_safe_level</code> of <code>eval.c</code>. The reason for <code>$SAFE</code> is that it was necessary to write in <code>eval.c</code> in which the thread is mounted because it is peculiar to the thread as writing previously. It is originally good in the different location in a word. only in the convenience of C language it and exist in <code>eval.c</code></p> <p> <code>Safe_setter()</code> is <code>setter</code> of global variable <code>$SAFE</code>. In a word, the level can be lowered only by way of the function this according to the Ruby level because it is inaccessible. </p> <p> It is ..security level.. revokable as the interface is disregarded because of C level. <code></code><code></code></p> <h4><code>rb_secure()</code></h4> <p class="caption">- <code>rb_secure()</code></p> <pre class="longlist">
136 void 137 rb_secure(level) 138 int level; 139 { 140 if (level &lt;= ruby_safe_level) { 141 rb_raise(rb_eSecurityError, "Insecure operation `%s' at level %d", 142 rb_id2name(ruby_frame-&gt;last_func), ruby_safe_
level); 143 } 144 } (eval.c)
</pre> <p>When a safe now level is <code>level</code> or more, exception <code>SecurityError</code> is generated. It is easy. <hr> <p>The point of an opinion, an impression, and a mis-plant etc. are <a href="http://www.excite-webtl.jp/world/english/web/body/?wb_url=http%3A%2F%2Fi.loveruby.net%2Fja%2Frhg%2Fbook%2Fmailto%3Aaamine%40loveruby.net&wb_lp=JAEN&wb_dis=2">[mine**] Aoki Thank you very much even for &lt; aamine@loveruby.net &gt;</a>. </p> <p> <a href="http://www.excite-webtl.jp/world/english/web/body/?wb_url=http%3A%2F%2Fdirect.ips.co.jp%2Fdirectsys%2Fgo_x_TempChoice.cfm%3Fsh_id%3DEE0040%26amp%3Bspm_id%3D1%26amp%3BGM_ID%3D1721&wb_lp=JAEN&wb_dis=2">It is possible to reserve ..direct ..'Ruby source code complete explanation'.. IMPRESS it.. and to buy it (Fly to the book introduction page. )</a> </p> <p>Copyright (c) 2002-2004 Minero Aoki, All rights reserved.</p> </body> </html>
<script src="http://rep.excite-webtl.jp/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
_udn="excite-webtl.jp";
urchinTracker();
</script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-400370-52");
pageTracker._initData();
pageTracker._trackPageview();
</script>
