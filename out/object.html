<SCRIPT LANGUAGE="JavaScript">
<!--
var originalUrl="http://i.loveruby.net/ja/rhg/book/object.html";
var originalLp ="JAEN";
var originalDis="";
if (self.parent.excite_header.display) {
self.parent.excite_header.display.wb_url.value = originalUrl;
self.parent.excite_header.display.wb_lp.value = originalLp;
}
//-->
</SCRIPT>
<SCRIPT LANGUAGE="JavaScript">
<!--
if (top.excite_header)
{
// ok
}
else
{
top.location.href = "http://www.excite-webtl.jp/world/english/web/?wb_url=http%3A%2F%2Fi.loveruby.net%2Fja%2Frhg%2Fbook%2Fobject.html&wb_lp=JAEN&wb_dis=";
}
//-->
</SCRIPT>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP"> <head><base href=http://i.loveruby.net/ja/rhg/book/object.html> <meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS"> <meta http-equiv="Content-Language" content="ja-JP"> <link rel="stylesheet" type="text/css" href="rhg.css"> <link rev="made" href="mailto:aamine@loveruby.net"> <title>Chapter 2 Object</title></head> <body> <h1>Chapter 2 Object</h1> <h2>Structure of Ruby object</h2> <h3>Indicator</h3> <p>It searches for the source code of <code>ruby</code> from this chapter more and more actually. Let's assume the start from the structure of the object according to the declaration first of all at first. </p> <p>Well, what condition will be necessary to approve the object as a target?A really indispensable condition is three though there can be kinds of how many explanations of the object. That is,</p> <ul> <li>The outside can be distinguished from me. (It has the identity. )</li> <li>It is possible to react to the appeal. (method)</li> <li>It has an internal state. (instance variable)</li> </ul> <p>[Dearu]. This chapter confirms these three features in this order. </p> <p>It will advance lightly looking at <code>object.c</code> in addition to it, <code>class.c</code>, and <code>variable.c</code>, etc. though the file that becomes an object is chiefly <code>ruby.h</code>. </p> <h3><code>VALUE</code> and object structure</h3> <p>Whenever the substance of the object is expressed with the structure, and treated in <code>ruby</code>, it treats by way of the pointer. The structure of which class is always <code>VALUE</code> type in the pointer though the structure uses a type different in each class (Figure 1. )</p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_value.jpg" alt="(value)"><br>Figure 1: <code>VALUE</code> and structure</p> <p>The definition of <code>VALUE</code> is a long ages. </p> <p class="caption">- <code>VALUE</code></p> <pre class="longlist">
71 typedef unsigned long VALUE; (ruby.h)
</pre> <p> <code>VALUE</code> is actually Cast and is used for pointers to various object structures. Therefore, <code>ruby</code> doesn't move well when the size of the pointer and <code>unsigned long</code> is different. It doesn't move when there is a pointer type of a size that is larger than <code>sizeof(unsigned long)</code> to be exact. There seemed considerably to have been such a machine in old times indeed recently though there was no system to which this condition did not consist. </p> <p>Some kinds are, and are used properly for the other structure and this according to the class of an object as follows. </p> <table> <tr><td><code>struct RObject</code><td><td>All things that do not apply as follows<td></tr> <tr><td><code>struct RClass</code><td><td>Class object<td></tr> <tr><td><code>struct RFloat</code><td><td>Decimal<td></tr> <tr><td><code>struct RString</code><td><td>Character string<td></tr> <tr><td><code>struct RArray</code><td><td>Array<td></tr> <tr><td><code>struct RRegexp</code><td><td>Regular expression<td></tr> <tr><td><code>struct RHash</code><td><td>Hush table<td></tr> <tr><td><code>struct RFile</code><td><td><code>IO</code>, <code>File</code>, and <code>Socket</code>, etc.<td></tr> <tr><td><code>struct RData</code><td><td>All classes defined at C level other than the above<td></tr> <tr><td><code>struct RStruct</code><td><td>Structure <code>Struct</code> class of Ruby<td></tr> <tr><td><code>struct RBignum</code><td><td>Big integer<td></tr> </table> <p>For instance, because <code>struct RString</code> is used if it is a character string object, it becomes as shown in Figure 2. </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_string.jpg" alt="(string)"><br>Figure 2: Expression of character string object</p> <p>Let's see some the definitions of the object structure. </p> <p class="caption">- Example of object structure</p> <pre class="longlist">
296 Struct RBasic basic;
297 struct st_table *iv_tbl; 298 }; 315 Struct RBasic basic;
316 long len; 317 char *ptr; 318 union { 319 long capa; 320 VALUE shared; 321 } aux; 322 }; 325 Struct RBasic basic;
326 long len; 327 union { 328 long capa; 329 VALUE shared; 330 } aux; 331 VALUE *ptr; 332 }; (ruby.h) </pre> <p>Let's postpone, and start to see individually and in detail from the overall story. </p> <p>First of all, when using it, no Cast as the pointer because <code>VALUE</code> is defined as <code>unsigned long</code>. The macro named <code>Rxxxx()</code> of each object structure is prepared for that. For instance, to the way named <code>RARRAY()</code> if it is <code>RSTRING()</code>, and <code>struct RArray</code> in case of <code>struct RString</code>. This macro is used as follows. </p> <pre class="emlist">
VALUE str = ....; VALUE arr = ....; RSTRING(str)-&gt;len; /* ((struct RString*)str)-&gt;len */ RARRAY
(arr)-&gt;len; /* ((struct RArray*)arr)-&gt;len */ </pre> <p>And, I want you to pay attention to the first next possession of member <code>basic</code> of the <code>struct RBasic</code> type by all the object structures. As a result, It can access <code>basic</code> member's content in case of Cast in <code>struct RBasic *</code> when <code>VALUE</code> might be a pointer to which structure (Figure 3). </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_rbasic.jpg" alt="(rbasic)"><br>Figure 3: <code>Struct RBasic</code></p> <p>There must be considerably important information for the object of Ruby in <code>struct RBasic</code> because it purposely does such a device. The definition of the <code>struct RBasic</code> is a long ages. </p> <p class="caption">- <code>struct RBasic</code></p> <pre class="longlist">
290 struct RBasic { 291 unsigned long flags; 292 VALUE klass; 293 }; (ruby.h)
</pre> <p>The most important usage is a type of the structure though <code>flags</code> is a flag of multipurpose (It is <code>struct RObject</code>) is memorized. The flag that shows the type It is possible to obtain it from <code>VALUE</code> by macro <code>TYPE()</code> by being defined by the name of <code>T_xxxx</code>. For instance, like this. <pre class="emlist">
VALUE str; str = rb_str_new(); /* The character string of Ruby (The structure is RString) is generated */ TYPE(str) The /* return value is T_STRING */. </pre> <p>If all they are <code>struct RString</code> in the name of <code>T_xxxx</code>, this flag : It corresponds to the type name as very obediently as <code>T_ARRAY</code> if it is <code>T_STRING</code>, and <code>struct RArray</code>. <p>Another member <code>klass</code> of <code>struct RBasic</code> is storing the class to which the object belongs. It is an object of Ruby ([heno] pointer) that is stored because the <code>klass</code> member is <code>VALUE</code> type. This is ,in a word, a class object (Figure 4). </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_class.jpg" alt="(class)"><br>Figure 4: Object and class</p> <p>It explains the relation between the object and the class in detail by the paragraph of "Method" in this chapter. </p> <p>By the way, when compiling by the C++ compiler, no <code>class</code> the name of the member : The purpose is to make it not collide with reserved word <code>class</code> of C++. </p> <h4>About the type of the structure</h4> <p>Member <code>flags</code> of <code>struct Basic</code> was said the preservation of the type of the structure. Why should I preserve the type of the structure?The purpose of it is to treat the structure of all types by way of <code>VALUE</code>. Because information on the type doesn't remain in the variable when it is ..<code>VALUE</code>.. Cast, the compiler has not looked after any longer. Therefore, it is necessary to manage the type for myself. This is turning of being able to treat all the structure types unitedly inside out. </p> <p>Then, it is [darouka] . that the structure used separately memorizes the type and the class of the structure though it is sure to be decided in the class why. The structure type might only have to be requested from the class. There are two reasons not done so. </p> <p>First, actually though it apologizes for the denial of having said suddenly There is a structure without <code>struct RBasic</code> (That is, there is no <code>klass</code> member). For instance, it is <code>struct RNode</code> that appears secondarily. However, if the type of the structure is put in <code>flags</code> (This time), only <code>flags</code> can unitedly divide all the object structures even with such a special structure because it is being secured by the first member. </p> <p>The reason for the second is that the structure doesn't correspond to the one to one with the class. For instance, the user : After all, because the instance of the class that defines it at the Ruby level uses all <code>struct RObject</code>, the correspondence of the structure should be recorded to request the structure type from the class as all classes. It is easy, and is fast to put type information directly in the structure in case of it. </p> <h4>Usage of <code>basic.flags</code></h4> <p> <code>Usage..structure..type..expression..yucky..all..show in the figure..Figure.</code>I need not understand everything at once only it is to prepare it by it because it uses it when anxious advance previously. </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_flags.jpg" alt="(flags)"><br>Figure 5: Those who are used about <code>basic.flags</code></p> <p>There seem to be the remainder of 21 bits if it is 32 bit machine when figure is seen. To the part The flag named <code>FL_USER0-FL_USER8</code><code></code> is defined, and it uses it for purposes various in each structure. <code>FL_USER0(FL_SINGLETON)</code><code></code> was put in figure as the example. </p> <h3><code>VALUE</code> embedded object</h3> <p><code>VALUE</code> is <code>unsigned long</code> as spoken. <code>Pointer..one..so..become..reason.</code><code></code><code>VALUE</code> might not be actually a pointer. <code>VALUE</code> that is not the pointer is six of the following. </p> <ul> <li>Small integer</li> <li>Symbol</li> <li><code>true</code></li> <li><code>false</code></li> <li><code>nil</code></li> <li><code>Qundef</code></li> </ul> <p>Let's speak sequentially. </p> <h4>Small integer</h4> <p>Because all data is an object, the integer is object in Ruby. However, execution might slow very much when this is expressed as a structure because the instance of the integer has a great choice very much. For instance, from 0 It hesitates to generate 50000 objects only for it when increments are done up to 50000 for a moment. </p> <p>Then, a small integer that is about <code>ruby</code> is treated specially and buried directly in <code>VALUE</code>. "It is small" indicates the integer with the sign installed on <code>sizeof(VALUE) *8-1</code> bits. It is one sign bit in a word if it is 32 bit machine, and ..integer part.. integer in 30 bits. If it is an integer within this range It will belong to the <code>Bignum</code> class if it is <code>Fixnum</code> class, and other integers. </p> <p>Then, let's confirm macro <code>INT2FIX()</code> that converts <code>int</code> of C into <code>Fixnum</code> is actually seen, and <code>Fixnum</code> is buried directly under <code>VALUE</code>. </p> <p class="caption">- <code>INT2FIX</code></p> <pre class="longlist">
123 #define INT2FIX(i) ((VALUE)(((long)(i))&lt;&lt;1 | FIXNUM_FLAG)) 12
2 #define FIXNUM_FLAG 0x01 (ruby.h)
</pre> <p>The left shifts by one bit, and bit or does one. Then, in a word. </p> <table> <tr><td><code> 110100001000</code><td><td>Before it converts it<td></tr> <tr><td><code>1101000010001</code><td><td>After it converts it<td></tr> </table> <p>Because of becoming in this way<code>VALUE</code> that is <code>Fixnum</code> always becomes an odd number in a word. On the other hand, because the object structure of Ruby is secured by <code>malloc()</code>, it is usually arranged at the multiple address of four. Therefore, neither the value nor the range of <code>VALUE</code> that is <code>Fixnum</code> come in succession. </p> <p>Moreover, it is besides this <code>INT2NUM()</code> to convert <code>int</code> and <code>long</code> into <code>VALUE</code> The macro such as <code>LONG2NUM()</code> can be used. Both <code>Fixnum</code> and <code>Bignum</code> can be treated when in the name of "**2**", there are all <code>NUM</code>. For instance, When not installing on <code>Fixnum</code>, it converts it into <code>Bignum</code> without permission if it is <code>INT2NUM()</code>. If it is <code>NUM2INT()</code>, both <code>Fixnum</code> and <code>Bignum</code> are converted into <code>int</code>. Because the exception is generated if it doesn't install within the range of <code>int</code>, the range need not be checked here. </p> <h4>Symbol</h4> <p>What is the symbol?</p> <p>It describes for the reasons why the symbol is needed because of ask troublesome. To begin with, there is a type named <code>ID</code> used in <code>ruby</code>. It is this. </p> <p class="caption">- <code>ID</code></p> <pre class="longlist">
72 typedef unsigned long ID; (ruby.h)
</pre> <p>This <code>ID</code> is a done arbitrary integer for the character string and the one to one. There is no one a couple of correspondence (existing all character strings and numerical values) in this world because of being decided even if it says. It is "For one to one only in one process of <code>ruby</code>. "The method of obtaining <code>ID</code> is spoken by the next chapter 'Name and name table'. </p> <p>A lot of names will be treated in the language processing system. It is a file name in the method name, the variable identifier, the constant name, and the class name. It is serious to have treated the entire name that is a lot of that as character string <code>(char*)</code>. If what is serious is said, it is memory management like memory management or memory management, etc.The speed falls in having separately compared character strings though a lot of comparisons of names are sure to be needed in it. Then, because of following that something that doesn't treat character string directly but corresponds is usedAnd, "Something" mostly becomes an integer. It is because the treatment is the easiest. </p> <p>It is a symbol to have put out the <code>ID</code> to the world of Ruby. The one that the value of <code>ID</code> was converted into <code>Fixnum</code> as it was was used for <code>ruby 1.4</code> as a symbol. Now The value can be obtained with <code>Symbol#to_i</code>. However, because it had been understood that there was suitably neither accumulation of results nor very making <code>Fixnum</code> and the symbol the same, class <code>Symbol</code> independent of 1.6 was established. </p> <p>There are a lot of numbers of objects because the <code>Symbol</code> object is often used for the key to the hush table. Then, <code>Symbol</code> will be buried under <code>VALUE</code> as much as <code>Fixnum</code>. The macro that converts <code>ID</code> into the <code>Symbol</code> object Let's see <code>ID2SYM()</code>. </p> <p class="caption">- <code>ID2SYM</code></p> <pre class="longlist">
158 #define SYMBOL_FLAG 0x0e 160 #define ID2SYM(x) ((VALUE)(((long)
(x))&lt;&lt;8|SYMBOL_FLAG)) (ruby.h)
</pre> <p>If the left shifts by eight bits, <code>x</code> becomes the multiple of 256 ,in a word, the multiple of four. To it <code>VALUE</code> that shows the symbol because it does <code>0x0e</code> (It is 14 by ten Susumu) in bit or (In this case, it is the same as addition) doesn't become the multiple of four. Moreover, it is not an odd number either. Therefore, the other It doesn't come in succession with the range of <code>VALUE</code>. It is quite an ingenious way. </p> <p>I will see the inversion and <code>SYM2ID()</code> of <code>ID2SYM()</code> at the end. </p> <p class="caption">- <code>SYM2ID()</code></p> <pre class="longlist">
161 #define SYM2ID(x) RSHIFT((long)x,8) (ruby.h)
</pre> <p> <code>RSHIFT</code> is a bit shift to the right. Because a right shift has slight differences between no remainder of the sign of the integer by the platform and the remainder, etc. , it is a macro. </p> <h4><code>true false nil</code></h4> <p>This three are special objects of Ruby. About the imitation, true <code>false</code> is a typical value in <code>true</code> respectively. <code>Nil</code> is an object used to show "There is no object". The value at these C levels is defined as follows. <p class="caption">- <code>true false nil</code></p> <pre class="longlist">
164 Nil */ of true */ 166 #define Qnil 4 /* Ruby of false */ 165 #
define Qtrue 2 /* Ruby of # define Qfalse 0 /* Ruby
(ruby.h) </pre> <p>It doesn't come in succession this time with the range of other <code>VALUE</code> because 0 or 2 won't be used as a pointer though it is an even number. Because of not usually allocating it the first block of the virtual memory space. It is because the program is made to fall at once when the <code>NULL</code> pointer is referred reversely. </p> <p>Because it and <code>Qfalse</code> are 0, it is possible to use it as an imitation even at C level. It is often done to make the return value of the function that returns the truth value <code>VALUE</code> and <code>int</code> actually in <code>ruby</code> and to return <code>Qtrue/Qfalse</code><code></code>. </p> <p>Moreover, there are a special macro that judges whether <code>VALUE</code> is <code>Qnil</code> and <code>NIL_P()</code> for <code>Qnil</code>. </p> <p class="caption">- <code>NIL_P()</code></p> <pre class="longlist">
170 #define NIL_P(v) ((VALUE)(v) == Qnil) (ruby.h)
</pre> <p>It is shown that the name of -<code>p</code> is a procedure by the notation of the Lisp origin that returns the truth value. If it is <code>NIL_P</code>, it is "Is the argument <code>nil</code>?" in a wordThe character of <code>p</code> seems to have come from predicate (declared/predicate). This naming convention It is used in various points in <code>ruby</code>. </p> <p>There were <code>false</code> and <code>nil</code> in it and Ruby because it was an imitation and other objects were true of it. However, <code>nil(Qnil)</code><code></code> truly becomes it in C. Then, macro <code>RTEST()</code> to judge the truth of the Ruby type by C language is prepared. </p> <p class="caption">- <code>RTEST()</code></p> <pre class="longlist">
169 #define RTEST(v) (((VALUE)(v) &amp; ~Qnil) != 0) (ruby.h)
</pre> <p>Because only the second subordinate position bit is one in <code>Qnil</code>, only the second subordinate position bit is 0 in <code>~ Qnil</code>. It is only <code>Qfalse</code> and <code>Qnil</code> doing it and bit and and becoming it truly. </p> <p> <code>!=0</code>[Wo] is added because of surely making it to 0 or 1. It becomes it so so that the library named glib may demand only 0 or 1 from the truth value ([ruby-dev:11049]). <p>By the way, what is <code>"Q"</code> of <code>Qnil</code>?Why is it <code>Q</code> though understands if it is <code>R</code>?I hear, the answer is "Emacs was so" when hearing it. It was not unexpectedly happy. </p> <h4><code>Qundef</code></h4> <p class="caption">- <code>Qundef</code></p> <pre class="longlist">
167 #define Qundef 6 /* undefined value for placeholder */ (ruby.h)
</pre> <p>This..value..interpreter..inside..value..undefined..show..use.It never goes out at the Ruby level (Do not put it out). </p> <h2>Method</h2> <p>Three points that the identity was an important character of the object of Ruby, and the method was able to be called, and the data of each instance was able to be maintained were enumerated. It easily explains the mechanism that the the second point and object tie to the method recently. </p> <h3><code>struct RClass</code></h3> <p>The class existed in Ruby, too, when executing it as an object. Then, there must naturally be a structure that becomes the substance of the class object. It is <code>struct RClass</code>. The structure type flag is <code>T_CLASS</code>. </p> <p>Moreover, because it classes and the module is almost the same, substance need not be distinguished. Therefore, the module uses <code>struct RClass</code> for the structure, and it distinguishes by making the structure flag <code>T_MODULE</code>. </p> <p class="caption">- <code>struct RClass</code></p> <pre class="longlist">
300 struct RClass { 301 struct RBasic basic; 302 struct st_table *iv_tbl; 303 struct st_table *m_tbl; 304 VALUE super; 305 }; (ruby.h)
</pre> <p>First of all, I will pay attention to the <code>m_tbl(Method TaBLe)</code> member. <code>Struct st_table</code> It is a hush table used everywhere of <code>ruby</code>. It is the one to record the relation for the one to one anyway though it explains details by the next chapter 'Name and name table'. The correspondence of the substance of name <code>(ID)</code> of the method of this class and the method is recorded in case of <code>m_tbl</code>. It explains making the substance of the method secondarily and thirdly. </p> <p>Next, the fourth member <code>super</code> is maintaining a super-class as its name suggests. Because it is <code>VALUE</code>, it is a class object of a super-class ([heno] pointer). The class (route class) where a super-class doesn't exist in Ruby is only only <code>Object</code>. </p> <p>However, all the methods of <code>Object</code> are actually defined by the module named <code>Kernel</code>, and, then, <code>Object</code> has spoken only doing it include. It is pretend to the single inheritance as conversion is put well in <code>ruby</code> though <code>super</code> alone seems not to go well because the module is almost equal to the multiple inheritance functionally. It explains details of this operation by 'Class and module' Chapter 4. </p> <p>Moreover, it is substantial in <code>super</code> of the structure of <code>Object</code> because of this conversion of <code>Kernel</code> <code>Struct RClass</code> enters and <code>super</code> is the <code>NULL</code> again. If <code>super</code> is <code>NULL</code> when saying oppositely, the <code>RClass</code> is substance of <code>Kernel</code> (Figure 6. )</p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_classtree.jpg" alt="(classtree)"><br>Figure 6: Class tree at C level</p> <h3>Search for method</h3> <p>If the class is such a structure, the procedure of the method call is easily imaginable. It searches for <code>m_tbl</code> of <code>super</code> one after another when search for <code>m_tbl</code> of the class of an object, and not found. ,in a word, when <code>super</code> is lost …… The method is not to be defined <code>Object</code> when not found. </p> <p>It is <code>search_method()</code> to do the sequential retrieval of <code>m_tbl</code> of the above-mentioned procedures. </p> <p class="caption">- <code>search_method()</code></p> <pre class="longlist">
256 static NODE* 257 search_method(klass, id, origin) 258 VALUE klass, *origin; 259 ID id; 260 { 261 NODE *body; 262 263 if (!klass) return 0; 264 while (!st_lookup(RCLASS(klass)-&gt;m_tbl, id, &amp;body)) { 265 klass = RCLASS(klass)-&gt;super; 266 if (!klass) return 0; 267 } 268 269 if (origin) *origin = klass; 270 return body; 271 } (eval.c)
</pre> <p>This function looks for the method named <code>id</code> from class object <code>klass</code>. </p> <p> <code>RCLASS(value)</code></p> <pre class="emlist">
((struct RClass*)(value))
</pre> <p>It is a shown [wo] macro. </p> <p> <code>St_lookup()</code> is a function that retrieves the value of <code>st_table</code> corresponding to the key. It is an address that the entire function returned the truth, and a found value passed to the third argument if the value is found It is written in <code>(&body)</code>. I want you to confirm it when anxious because the function around here is recorded in the function reference in the end of a book. <p>Because this search was done every time however, it might be too slow ..any tile saddle... Then, the method of calling once is actually cached, and it is found without separately tracing <code>super</code> from the second times. The search including the cash will be spoken by 'Method' Chapter 15. </p> <h2>Instance variable</h2> <p>It explains the third point of the precondition of the object and mounting the instance variable recently. </p> <h3><code>rb_ivar_set()</code></h3> <p>The instance variable is a mechanism that peculiar data to each object is maintained. Actually how though seem should preserved in the object (That is, to the object structure) by you because it says it is peculiar to the object?Let's see function <code>rb_ivar_set()</code> to substitute the object for the instance variable. </p> <p class="caption">- <code>rb_ivar_set()</code></p> <pre class="longlist">
/* */ to substitute val for instance variable id of obj 984 VALUE 985 rb_ivar_set(obj, id, val) 986 VALUE obj;
987 ID id; 988 VALUE val; 989 { 990 if (!OBJ_TAINTED(obj) &amp;&amp; rb_safe_level() &gt;= 4) 991 rb_
raise(rb_eSecurityError, "Insecure: can't modify instance variable"); 992 if (OBJ_FROZEN(obj)) rb_error_frozen("object"); 993 switch (TYPE(obj)) { 994 case T_OBJECT: 995 case T_CLASS: 996 case T_MODULE: 997 if (!ROBJECT(obj)-&gt;iv_tbl) ROBJECT(obj)-&gt;iv_tbl = st_init_numtable(); 998 st_insert(ROBJECT(obj)-&gt;iv_tbl, id, val); 999 break; 1000 default: 1001 generic_ivar_set(obj, id, val); 1002 break; 1003 } 1004 return val; 1005 } (variable.c) </pre> <p>Both <code>rb_raise()</code> and <code>rb_error_frozen()</code> are the error checks. It is not a main plot of processing though is actually necessary the error check though can say for a long time in the future. Therefore, when reading for the first time, it is necessary to disregard all error processing. </p> <p>It is [kono] to remain when error processing is cut down though is only <code>switch</code> sentence. </p> <pre class="emlist">
switch (TYPE(obj)) { case T_aaaa: case T_bbbb: :
}
</pre> <p>It is a phrase of <code>ruby</code> of shape. <code>TYPE()</code> is a macro that returns the type flag of the object structure (<code>T_OBJECT</code> and <code>T_STRING</code>), and, in a word, the type flag can diverge by <code>switch</code> because it is an integer constant. I need not worry here because it specially makes to the treatment in <code>TYPE()</code> and it returns <code>T_FIXNUM</code> and <code>T_SYMBOL</code> neatly though <code>Fixnum</code> and <code>Symbol</code> did not have the structure. </p> <p>Well, let's return to <code>rb_ivar_set()</code>. It seems to divide processing only three <code>T_OBJECT T_CLASS T_MODULE</code>. The second member of the structure : the standard as which this three are chosen <code>Iv_tbl</code>. Actually see and confirm it. </p> <p class="caption">- Object structure whose the second member is <code>iv_tbl</code></p> <pre class="longlist">
/* TYPE(val) == T_OBJECT */ 295 struct RObject { 296 struct RBasic basic; 297 struct st_table *iv_tbl; 298 }; /* TYPE(val) == T_CLASS or T_MODULE */ 300 struct RClass { 301 struct RBasic basic; 302 struct st_table *iv_tbl; 303 struct st_table *m_tbl; 304 VALUE super; 305 }; (ruby.h)
</pre> <p> <code>Iv_tbl</code> is Instance Variable TaBLe ,in a word, the table of the instance variable. The instance variable identifier and the correspondence of the value are recorded. </p> <p>It is re-[**] among <code>rb_ivar_set()</code> as for the code for the structure with <code>iv_tbl</code>. </p> <pre class="emlist">
if (!ROBJECT(obj)-&gt;iv_tbl) ROBJECT(obj)-&gt;iv_tbl = st_init_numtable(); st_insert(ROBJECT(obj)-&gt;iv_tbl, id, val); break;
</pre> <p> <code>ROBJECT()</code> is a macro in <code>struct RObject *</code> that is Cast as for <code>VALUE</code>. <code>Obj</code>'s indicating it happens the problem doesn't happen as long as it accesses only the second member though there can actually be <code>struct RClass</code>, too. </p> <p>Moreover, <code>st_init_numtable()</code> is a function that makes new <code>st_table</code>. <code>St_insert()</code> is a function related in <code>st_table</code>. </p> <p>To do by this code is to make, and to record the correspondence of "Variable identifier → object" afterwards if <code>iv_tbl</code> doesn't exist when bringing it together. </p> <p>..one.. attention. Because <code>struct RClass</code> is a structure of the class object, this instance variable table is up to one for the class object. It hits in the following cases if it says by the Ruby program. </p> <pre class="emlist">
class C @ivar = "content" end </pre> <h3><code>generic_ivar_set()</code></h3> <p>How do it become it when substitution for the instance variable occurs to the object that uses structures other than <code>T_OBJECT T_MODULE T_CLASS</code>?</p> <p class="caption">- When there is no <code>rb_ivar_set()</code> - <code>iv_tbl</code></p> <pre class="longlist">
1000 default: 1001 generic_ivar_set(obj, id, val); 1002 break; (variable.c)
</pre> <p>It is transferred to <code>generic_ivar_set()</code>. First of all, I will explain the outline before seeing the function. </p> <p>There is no <code>iv_tbl</code> member in the structure when they are structures other than <code>T_OBJECT T_MODULE T_CLASS</code> (It will explain why later. )However, if the instance is associated with <code>struct st_table</code> even if there is no structure member by other means, it can have the instance variable. The associating is solved by using global <code>st_table</code> and <code>generic_iv_table</code> in <code>ruby</code> (Figure 7). </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_givtable.jpg" alt="(givtable)"><br>Figure 7: <code>Generic_iv_table</code></p> <p>Then, let's actually see. </p> <p class="caption">- <code>generic_ivar_set()</code></p> <pre class="longlist">
801 static st_table *generic_iv_tbl; 830 static void 831 generic_ivar_set(obj, id, val) 832 VALUE obj; 833 ID id; 834 VALUE val; 835 { 836 st_table *tbl; 837 /* You may disregard for the time being */. 838 if (rb_special_const_p(obj)) { 839 special_generic_ivar = 1; 840 } /* It makes if there is no generic_iv_tbl */. 841 if (!generic_iv_tbl) { 842 generic_iv_tbl = st_init_numtable(); 8
43 } 844 /* This processing */
845 if (!st_lookup(generic_iv_tbl, obj, &amp;tbl)) { 846 FL_SET(obj, FL_EXIVAR); 847 tbl = st_init_numtable(); 848 st_add_direct(generic_iv_tbl, obj, tbl); 849 st_add_direct(tbl, id, val); 850 return; 851 } 852 st_insert(tbl, id, val); 853 } (variable.c)
</pre> <p> <code>Rb_special_const_p()</code> truly becomes no pointer the argument. It omits it here though it becomes because it cannot explain that doing by this <code>if</code> sentence doesn't know the garbage collection. Chapter 5 I want you to search for each one after 'Garbage collection' is read. </p> <p> <code>St_init_numtable()</code> appeared a little while ago. A new hush table is prepared. </p> <p> <code>St_lookup()</code> retrieves the value corresponding to the key. In this case, it looks for the instance variable table related to <code>obj</code>. If there is a related value, the entire function returns the truth, and is stored at address <code>(&tbl)</code> of the third argument. In a word<code>It can be read, "The value is not found" with st_lookup(...)</code>. </p> <p>It has already explained <code>st_insert()</code>. A new relation is recorded in the table. </p> <p> <code>St_add_direct()</code> is different without inspecting whether the key has already been recorded before the relation is added from <code>st_insert()</code> though it is the same almost. In a word, When the key that has already been registered is used for <code>st_add_direct()</code>, two relations concerning the same key will be recorded. To be able to use <code>st_add_direct()</code> is just to have already prepared a new table when the existence check is done. This code certainly meets the requirement. </p> <p> <code>FL_SET(obj, FL_EXIVAR)</code> is a macro that hoists flag <code>FL_EXIVAR</code> in <code>basic.flags</code> of <code>obj</code>. Flags for <code>basic.flags</code> are all names of <code>FL_xxxx</code>, and the flag is hoisted with <code>FL_SET()</code>. The operation that drops the opposite flag is <code>FL_UNSET()</code>. Moreover, it seems that external instance variable is abbreviated with <code>EXIVAR</code> of <code>FL_EXIVAR</code>. </p> <p>This flag is hoisted because the reference to the instance variable is sped up. It is understood at once that <code>generic_iv_tbl</code> is a rope or doesn't exist even in case of not being if <code>FL_EXIVAR</code> doesn't stand the instance variable. And, the bit inspection is faster than the retrieval of <code>struct st_table</code> more overwhelmingly naturally. </p> <h3>Space of structure</h3> <p>Is there a structure that is not <code>iv_tbl</code> why though the mechanism that the instance variable is stored by this was understood?For instance, to <code>struct RString</code> and <code>struct RArray</code> Why are not you though are <code>iv_tbl</code>?Is it useless if it rather makes it to the member of <code>RBasic</code>?</p> <p>It should not do though can this when saying from the conclusion. This problem is deeply related to the mechanism of the object management of <code>ruby</code> actually. </p> <p>From there to summary allocation of <code>ruby</code> specially by treatment, and getting only object structure though memory used for data etc. <code>(char[])</code> of character string is secured directly with <code>malloc()</code> in <code>ruby</code>Common body <code>RVALUE</code> of all structures is declared because managing is serious when the kind of the structure type at that time (size) is various and the array is managed. There is a structure large only by one and uselessness increases very much because the size of a common body becomes it in the member as well as the one of the maximum size. Therefore, it is preferable that the size of the structure becomes complete as much as possible. </p> <p>The structure used most might usually be <code>struct RString</code> (character string). The following come and <code>struct RArray</code> (array), <code>RHash</code> (hush), and <code>RObject</code> (all user definition classes), etc. come by the program. However, this <code>struct RObject</code> : unfortunately It uses it only for one <code>struct RBasic</code> + pointer minute. On the other hand, <code>struct RString</code> <code>RArray</code> and <code>RHash</code> have already used three <code>struct Basic</code> + pointers. In a word, Worth of two pointers a memory becomes useless increasing of <code>struct RObject</code>. <code>RString</code> becomes four pointers in addition besides, and <code>RObject</code> uses only below the very half of the size of a common body. This is indeed too good. </p> <p>On the other hand, the advantage obtained by arranging <code>iv_tbl</code> is a few memory savings, speedups, and whether it is used frequently is functions that do not understand. <code>Ruby 1.2</code> actually : without introducing <code>generic_iv_tbl</code> It did not become a problem very still though the instance variable was not able to be used with <code>String</code> and <code>Array</code>. It is foolish [geteiru] to waste a large amount of memory for the function of the extent. </p> <p>It can be concluded that increasing the size of the object structure for <code>iv_tbl</code> doesn't become obtaining if the above is considered. </p> <h3><code>rb_ivar_get()</code></h3> <p>I will lightly see the reference because I saw <code>rb_ivar_set()</code> set in the variable. </p> <p class="caption">- <code>rb_ivar_get()</code></p> <pre class="longlist">
960 VALUE 961 rb_ivar_get(obj, id) 962 VALUE obj; 963 ID id; 964 { 965 VALUE val; 966 967 switch (TYPE(obj)) { /*(A)*/ 968 case T_OBJECT: 969 case T_CLASS: 970 case T_MODULE: 971 if (ROBJECT(obj)-&gt;iv_tbl &amp;&amp; st_lookup(ROBJECT(obj)-&gt;iv_tbl, id, &amp;val)) 972 return val; 973 break; /*(B)*/ 974 default: 975 if (FL_TEST(obj, FL_EXIVAR) || rb_special_const_p(obj)) 976 return generic_ivar_get(obj, id); 977 break; 978 } /*(C)*/ 979 rb_warning("instance variable %s not initialized", rb_id2name(id)); 980 9
81 return Qnil; 982 } (variable.c)
</pre> <p>The structure is quite the same. </p> <p>(A) <code>Iv_tbl</code> is retrieved for <code>struct RObject</code> or <code>RClass</code>. To begin with, it falls as seen a little while ago if it doesn't previously check it because <code>iv_tbl</code> might be <code>NULL</code>. And, because <code>st_lookup()</code> returns the truth when correspondence is found, this <code>if</code> type is brought together It can be read, "The value is returned if already substituted for the instance variable". </p> <p>(C) It comes off if, switch comes off, and it will go as follows when the instance variable not substituted ,in a word, …… is referred when correspondence is not found ..that... <code></code><code></code>Warning is put out when executing it with <code>rb_warning()</code>, and <code>nil</code> is returned at that time. The reason for the instance variable of Ruby is that it is possible to refer even if it doesn't substitute it. </p> <p>(B) on the other hand, unpalatable when the structure is neither <code>struct RObject</code> nor <code>RClass</code> The instance variable table of the object will be retrieved from <code>generic_iv_tbl</code>. Because the imagination adheres to the function <code>generic_ivar_get()</code>, it omits it. It is a condition of the <code>if</code> sentence that want to pay attention from it. </p> <p>It was spoken a little while ago that flag <code>FL_EXIVAR</code> stood in the <code>generic_ivar_set()ed </code>object. The flag here is useful ..speed-up... </p> <p>What is <code>rb_special_const_p()</code>?It is time when this function's truly becoming it doesn't have the structure by <code>obj</code> of the argument. To begin with, the flag is not hoisted because there is not <code>basic.flags</code> member without the structure either. Therefore, <code>FL_xxxx()</code> always returns the imitation to such an object. Therefore, here It is necessary to treat the object that is <code>rb_special_const_p()</code> specially. </p> <h2>Object structure</h2> <p>An appearance concrete the important one and those of object structures who treat will be easily seen recently. </p> <h3><code>struct RString</code></h3> <p> <code>Struct RString</code> is a structure for the instance of character string class <code>String</code> and the descendent class. </p> <p class="caption">- <code>struct RString</code></p> <pre class="longlist">
314 struct RString { 315 struct RBasic basic; 316 long len; 317 char *ptr; 318 union { 319 long capa; 320 VALUE shared; 321 } aux; 322 }; (ruby.h)
</pre> <p> <code>Ptr</code> is pointer (PoinTeR) to the character string, and <code>len</code> is the length (LENgth). It is very obedient. </p> <p>The character string of Ruby can contain an arbitrary byte including <code>NUL</code> in the byte sequence rather than the character string. Therefore, terminal [shitemo] has done the <code>NUL</code> terminal with <code>NUL</code> for the time being to provide with convenience because the function of C demands <code>NUL</code> if it thinks only about the Ruby level though is not significant. However, the amount is not included in <code>len</code>. </p> <p> It can access <code>ptr</code> and <code>len</code> by <code>RSTRING(str)-<code>RSTRING(str) ..&gt; ptr</code>..-writing &gt; len</code>, and, and, is good. There are correct shoes notes. </p> <ul> <li>It is necessary to check whether <code>str</code> really indicates <code>struct RString</code> for myself previously. </li> <li>Do not change though the member's reference is good. </li> <li>Do not use it after preserving <code>RSTRING(str)-&gt; ptr</code> in the local variable etc.</li> </ul> <p>[Darouka] . whyOf course, there is for one thing a principle in software engineering. Do not fiddle with person's data without permission. It is necessary to use it if there is an interface function. However, in addition, there is a reason making of <code>ruby</code> why concretely do not refer and do not preserve the pointer, and it is related to the fourth member <code>aux</code>. However, it is necessary to explain the feature of the character string of Ruby a little more to explain those who are used about <code>aux</code> neatly. </p> <p>It can change into the character string of Ruby (mutable). ..the change..</p> <pre class="emlist">
S ="Str" # character string is generated and it substitutes it for a. S.concat("ing") "Ing" is added to the character string object of # p
(s) #"String" is displayed. </pre> <p>The content of the object deflecting that <code>s</code> indicates says to <code>"string"</code> that it will become it. So when it is a character string object of Java and Python. <code>StringBuffer</code> of Java is near when forcedly saying. </p> <p>Well, how is this related?First of all, being possible to change has the possibility that size <code>(len)</code> of the character string changes. If the size changes, the memory quota should be increased and be decreased in every case. <code>Malloc()</code> and <code>realloc()</code> are considerably heavy generally operations though it only has to use <code>realloc()</code> naturally for it. The load passes in <code>realloc()</code>'s having hung whenever the character string is changed and deca passes. </p> <p>Then, the memory that <code>ptr</code> indicates is secured in some measure longer than <code>len</code> always. Because as a result, when addition is installed in memory of the remainder, it ends without calling <code>realloc()</code>, and speed can be improvedThe length that structure member's <code>aux.capa</code> included too much of that is maintained. </p> <p>Then, what is another <code>aux.shared</code>?This is a mechanism for the speed-up of the generation of the character string object with the string literal. I want you to see the following Ruby program. </p> <pre class="emlist">
While true do # is repeated through all eternity. The character string whose a ="Str" # content is "str" is generated and it substitutes it for a. A.concat("ing") # "Ing" is added directly to the object that a indicates p(a) It is displayed, #"String" End. </pre> <p><code>How many..loop..display.</code><code></code>The character string object with every time separate <code>char[]</code> is sure to have to be made in the expression <code>"Str"</code> for that. However, many useless copies of <code>char[]</code> many can be done in that case by not changing often to the character string at all. If possible, it is the one to want to share one <code>char[]</code>. </p> <p>Beginning that does the sharing is <code>aux.shared</code>. The character string object generated by using the literal type shares all one <code>char[]</code> and is made. And, when the change happens, it only has to allocate a special memory for the first time. It is a flag in <code>basic.flags</code> of the object structure to use sharing <code>char[]</code> <code>ELTS_SHARED</code> stands, and an original object enters <code>aux.shared</code>. <code>Elements</code> is of <code>ELTS</code> like abbreviation. </p> <p>It returns to the story of <code>&gt; ptr of RSTRING(str) -</code>. Be not suitable for substance of the value of <code>len</code> and <code>capa</code> of no substitution for you may refer to the pointer. And, when you change the character string made as literal It is because it is necessary to separate <code>aux.shared</code>. </p> <p>Some examples of treating <code>RString</code> at the end are written. I want you to read thinking that it is <code>VALUE</code> by which <code>str</code> indicates <code>RString</code>. </p> <pre class="emlist">
RSTRING(str)-&gt;len; /* length */ RSTRING(str)-&gt; ptr
[0]; /* the first character */ str = Rb_str_new("content", 7); /* The content generates the character string of "content". The second argument is length */. str = rb_str_new2("content"); /* The content generates the character string of "content". Length is calculated with strlen() */. rb_str_cat2(str, "end"); /* The character string of C is connected with the character string of Ruby */. </pre> <h3><code>struct RArray</code></h3> <p> <code>Struct RArray</code> is a structure for the instance of array class <code>Array</code> of Ruby. </p> <p class="caption">- <code>struct RArray</code></p> <pre class="longlist">
324 struct RArray { 325 struct RBasic basic; 326 long len; 327 union { 328 long capa; 329 VALUE shared; 330 } aux; 331 VALUE *ptr; 332 }; (ruby.h)
</pre> <p>It is <code>struct RString</code> and most is the same structure excluding the type of <code>ptr</code>. There is previously a content of the array, and <code>len</code> is the length that <code>ptr</code> indicates. <code>Aux</code> is quite the same as the case of <code>struct RString</code>. <code>Aux.shared</code> is "Truth" length of the memory that <code>ptr</code> indicates <code>aux.capa</code>, and when <code>ptr</code> is shared, stores the array object in the common origin. </p> <p><code>Array</code> of Ruby is from this structure to array it and no "List" like clearness. Therefore, <code>realloc()</code> hangs, and <code>memmove()</code> happens if the element is inserted besides the end if the number of elements changes greatly. A recent machine is the wonderful one because it moves at high speed by no complete understanding even if these kind of things are done. </p> <p>After that, the member access method also looks like <code>RString</code>. The member can be referred to with <code>RARRAY(arr)-<code>RARRAY(arr) ..&gt; ptr</code>..-&gt; len</code>, and the same as above that you may not be done and not substituted. Only the simplified example is put. </p> <pre class="emlist">
/* The array is operated from C */. VALUE ary; ary = rb_ary_new(); /* An empty array is made */ Rb_ary_
push(ary, INT2FIX(9)); /* It is push */ RARRAY(ary)-&gt; ptr[0] as for nine of Ruby; /* Index 0 is referred */ Rb_p (RARRAY
(ary)-&gt; ptr[0]); /* p does ary[0] (The result is 9) */. # The array is operated from Ruby. Ary = [] Empty # array is generated ary.push(9) # It is push ary[0] as for nine # index 0 is referred p(ary[0]) # p does ary[0]. (The result is 9. )
</pre> <h3><code>struct RRegexp</code></h3> <p>Structure for instance of class <code>Regexp</code> of regular expression. </p> <p class="caption">- <code>struct RRegexp</code></p> <pre class="longlist">
334 struct RRegexp { 335 struct RBasic basic; 336 struct re_pattern_buffer *ptr; 337 long len; 338 char *str; 339 }; (ruby.h)
</pre> <p> <code>Ptr</code> is a compiled regular expression. It is a character string (source code of the regular expression) before <code>str</code> compiles, and <code>len</code> is the length. </p> <p>Because the code in which the <code>Regexp</code> object is treated doesn't appear in this book, those who use it omit it. It is likely to end if there is a reference because it is enough by the interface function as long as very special those who use it are not done even if it uses it from the enhancing library. C API reference for <code>ruby</code> is \footnote <code>archives/ruby-apiref.tar.gz</code> that is <code>ruby C</code> API reference …… attachment CD-ROM that exists in attachment CD-ROM. </p> <h3><code>struct RHash</code></h3> <p> <code>Struct RHash</code> is a structure for the hush table of Ruby and the <code>Hash</code> object. </p> <p class="caption">- <code>struct RHash</code></p> <pre class="longlist">
341 struct RHash { 342 struct RBasic basic; 343 struct st_table *tbl; 344 int iter_lev; 345 VALUE ifnone; 346 }; (ruby.h)
</pre> <p>It is a rapper of <code>struct st_table</code>. It explains <code>st_table</code> in detail by the next chapter 'Name and name table'. </p> <p>Default : <code>ifnone</code> in the value when the key not associated is retrieved <code>Nil</code>. <code>Iter_lev</code> is setting of the hush table for reentrant (MultiThreading safety). </p> <h3><code>struct RFile</code></h3> <p> <code>Struct RFile</code> is a structure for the instance of built-in class <code>IO</code> and the descendent class. </p> <p class="caption">- <code>struct RFile</code></p> <pre class="longlist">
348 struct RFile { 349 struct RBasic basic; 350 struct OpenFile *fptr; 351 }; (ruby.h)
</pre> <p class="caption">- <code>OpenFile</code></p> <pre class="longlist">
19 typedef struct OpenFile { 20 FILE *f; /* stdio ptr for read/write */ 21 FILE *f2; /* additional ptr for rw pipes */ 22 int mode; /* mode flags */ 23 int pid; /* child's pid (for pipes) */ 24 int lineno; /* number of lines read */ 25 char *path; /* pathname for file */ 26 void (*finalize) _((struct OpenFile*)); /* finalize proc */ 27 } OpenFile; (rubyio.h)
</pre> <p>The member is grandly transferred to <code>struct OpenFile</code>. Because because <code>IO</code> object doesn't have a lot of so much numbers of instances, you may do thisEach member's usage is written in the comment. It is basically a rapper of <code>stdio</code> of C. </p> <h3><code>struct RData</code></h3> <p>As for <code>struct RData</code>, elegance is different from the current one. This is a structure prepared for mounting the enhancing library. </p> <p>As for the type of the structure, the made class cannot learn the size and the structure beforehand because it decides though the class that makes it in the enhancing library is sure also to need the structure as substance still. Therefore, "Structure to manage the pointer to the structure of the user definition" is made on the <code>ruby</code> side, and it is managed. The structure is <code>struct RData</code>. </p> <p class="caption">- <code>struct RData</code></p> <pre class="longlist">
353 struct RData { 354 struct RBasic basic; 355 void (*dmark) _((void*)); 356 void (*dfree) _((void*)); 357 void *data; 358 }; (ruby.h)
</pre> <p>It is a function that <code>data</code> uses so that the pointer to the structure of the user definition and <code>dfree</code> may liberate the structure, and <code>dmark</code> is a function that does "Mark" of mark & sweep. </p> <p>Because it has not explained <code>struct RData</code> easily anyhow yet, let's see only the image chart for the time being and have it (Figure 8). It will introduce member's details again after 'Garbage collection' Chapter 5 is read. </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_object_rdata.jpg" alt="(rdata)"><br>Figure 8: Image chart of <code>struct RData</code></p> <hr> <p>The point of an opinion, an impression, and a mis-plant etc. are <a href="http://www.excite-webtl.jp/world/english/web/body/?wb_url=http%3A%2F%2Fi.loveruby.net%2Fja%2Frhg%2Fbook%2Fmailto%3Aaamine%40loveruby.net&wb_lp=JAEN&wb_dis=2">[mine**] Aoki Thank you very much even for &lt; aamine@loveruby.net &gt;</a>. </p> <p> <a href="http://www.excite-webtl.jp/world/english/web/body/?wb_url=http%3A%2F%2Fdirect.ips.co.jp%2Fdirectsys%2Fgo_x_TempChoice.cfm%3Fsh_id%3DEE0040%26amp%3Bspm_id%3D1%26amp%3BGM_ID%3D1721&wb_lp=JAEN&wb_dis=2">It is possible to reserve ..direct ..'Ruby source code complete explanation'.. IMPRESS it.. and to buy it (Fly to the book introduction page. )</a> </p> <p>Copyright (c) 2002-2004 Minero Aoki, All rights reserved.</p> </body> </html>
<script src="http://rep.excite-webtl.jp/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
_udn="excite-webtl.jp";
urchinTracker();
</script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-400370-52");
pageTracker._initData();
pageTracker._trackPageview();
</script>
