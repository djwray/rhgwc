<SCRIPT LANGUAGE="JavaScript">
<!--
var originalUrl="http://i.loveruby.net/ja/rhg/book/load.html";
var originalLp ="JAEN";
var originalDis="";
if (self.parent.excite_header.display) {
self.parent.excite_header.display.wb_url.value = originalUrl;
self.parent.excite_header.display.wb_lp.value = originalLp;
}
//-->
</SCRIPT>
<SCRIPT LANGUAGE="JavaScript">
<!--
if (top.excite_header)
{
// ok
}
else
{
top.location.href = "http://www.excite-webtl.jp/world/english/web/?wb_url=http%3A%2F%2Fi.loveruby.net%2Fja%2Frhg%2Fbook%2Fload.html&wb_lp=JAEN&wb_dis=";
}
//-->
</SCRIPT>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja-JP"> <head><base href=http://i.loveruby.net/ja/rhg/book/load.html> <meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS"> <meta http-equiv="Content-Language" content="ja-JP"> <link rel="stylesheet" type="text/css" href="rhg.css"> <link rev="made" href="mailto:aamine@loveruby.net"> <title>Chapter 18 Loading</title></head> <body> <h1>Chapter 18 Loading</h1> <h2>Outline</h2> <h3>Interface</h3> <p>There are two procedures that can be used for loading at the Ruby level. It is <code>require</code> and <code>load</code>. </p> <pre class="emlist">
Require 'Uri'# The library of URI is loaded The resource file of something load '/home/foo/.myrc'# is read. </pre> <p>Both are usual methods, and it is compiled, and it is evaluated quite similarly to other codes. In a word, loading happens after it compiles completely and it moves to the stage of the evaluation. </p> <p>As for two interfaces, the usage is clearly separated. Trying to load <code>require</code> and an arbitrary file when the library is loaded is <code>load</code>. Let's explain the feature in detail respectively. </p> <h4><code>require</code></h4> <p>The feature of <code>require</code> is four points. </p> <ul> <li>It looks for the file from the loading passing. </li> <li>The enhancing library can be loaded. </li> <li>Extension. <code>It is ..rb/.so</code><code></code>.. omissible. </li> <li>The same file is not loaded two times or more. </li> </ul> <p>The loading passing of Ruby is in the global variable of <code>$and </code>the value is a string array. For instance, when contents of <code>$were </code>displayed in the environment that the author was usually using, it became it so. </p> <pre class="screen">
% ruby -e 'puts $:' /usr/lib/ruby/site_ruby/1.7 /usr/lib/ruby/site_ruby/1.7/i686-linux /usr/lib/ruby/site_ruby /usr/
lib/ruby/1.7 /usr/lib/ruby/1.7/i686-linux .
</pre> <p>It is easy to see very much because one element is displayed in the line only by doing <code>puts</code> as for the array. </p> <p>Usualness enters<code>/usr/local/lib/ruby</code> or less though passing is<code>/usr/lib/ruby</code> or less in the library because he or she does <code>configure</code> by <code>-- prefix=/usr</code> the author. The drive letter adheres further if it is Windows environment, too. </p> <p>Well, let's do <code>nkf.so</code> in a standard library from this loading passing by <code>require</code>. </p> <pre class="emlist">
require 'nkf' </pre> <p> <code>Require</code> supplements the extension without permission if the extension has not adhered to the name (Let's call the <code>require</code> name) that does <code>require</code>. First of all,<code>Try rb</code>, and, next,<code>So</code> is tried. Of course, if it is independent in each platform, and it is Windows environment, the extension in the enhancing library :. <code>Try dll</code>, and if it is Mac OS X. <code>Bundle</code> is tried. </p> <p>Let's use and simulate author's environment. <code>Ruby</code> sequentially confirms the following passing. </p> <pre class="emlist">
/usr/lib/ruby/site_ruby/1.7/nkf.rb /usr/lib/ruby/site_ruby/1.7/nkf.so /usr/lib/ruby/site_ruby/1.7/i686-linux/nkf.rb /usr/lib/ruby/site_ruby/
1.7/i686-linux/nkf.so /usr/lib/ruby/site_ruby/nkf. </pre> <p><code>Nkf.so</code> was found by <code>/usr/lib/ruby/1.7/i686-linux</code>. The lock is put for …… that doesn't load the last same feature …… file of <code>require</code> twice when found. The character string ..lock.. ..<code>$"</code>This time in the string array that exists in the global variable<code>" nkf.so "</code>.. enters. When putting it in <code>$"even if the </code>extension was omitted when </code>doing, it becomes a file name in which it is supplemented. <code></p> <pre class="emlist">
P $ "# ["nkf.so"] Require 'Nkf'# When nkf is loaded, …… It is locked. Anything doesn't happen even if require is done another times of require 'Nkf'#. P $ "# ["nkf.so"] The content of the lock array doesn't change. </pre> <p>There are two reasons why the extension is supplemented with <code>$"</code> .. <code>nkf.rb</code>.. <code>nkf.so</code> makes both loaded. <code></code>Moreover, an actual extension : in each platform. <code>Whenever you lock though so .dll .bundle</code> etc. were asunder. <code>It becomes so</code>. Therefore, always while being writing the Ruby program disregarding the difference of the extension. <code>You may assume so</code>. Here. <code>: of <code>ruby</code> around become so</code> It is a reason called UNIX aim. </p> <p>By the way, because it is possible to fiddle with <code>$"according to the </code>Ruby level as liked, it cannot be said a strong lock. For instance, if <code>$"is </code>cleared, the same enhancing library can be loaded many times. </p> <h4><code>load</code></h4> <p> <code>Load</code> is very easy compared with <code>require</code>. It looks for the file from <code>$</code>as well as <code>require</code>. Only the Ruby program : loading. Moreover, the extension should be not omissible, and a complete file name be always specified. </p> <pre class="emlist">
The URI library of load 'Uri.rb'# standard attachment is loaded. </pre> <p>The full path is specified and it is those to load the resource file who use it ..completing.. [na] about <code>load</code> though the library was loaded as a simplified example here. </p> <h3>Flow of the entire processing</h3> <p>The operation "The file is loaded" : when giving up and dividing roughly. </p> <ul> <li>The file is found. </li> <li>The map is done to the internal format ..including reading a file... </li> <li>It evaluates it. </li> </ul> <p>It divides into [san] stage drinking. It is only a procedure for finding the file that differs by <code>require</code> and <code>load</code>. There is no difference when the remainder might be <code>load</code> if might <code>require</code>. </p> <p>It explains the stage of the last evaluation only a little more. The loaded program is evaluated basically top-level at the Ruby program. If the constant is defined in a word, it becomes the constant of top-level, and if the method is defined, it becomes the method of the function style. </p> <pre class="emlist">
### mylib.rb MY_OBJECT = Object.new def my_p(obj) p obj end ### first.rb require 'mylib' The constant and the method of defining my_p MY_OBJECT # with another file can be used. </pre> <p>However, when the file changes, only the local variable scope of top-level becomes another. The local variable cannot be shared between another files in a word. Though it is possible to share if of course <code>Proc</code> others are made good use of, Load..mechanism..with..share.</p> <p>There are it and a person who sometimes misunderstands it, and it doesn't change the class's being loaded wherever it loads it ahead. For instance, there is not a meaning even if it loads it in the <code>module</code> sentence as follows, and either all certain things are put top-level top-level about the file. </p> <pre class="emlist">
Module SandBox ..require 'Mylib' top-level # it.. ..doing require... Even if require is done in require 'Mylib'# module, the result is the same. end </pre> <h3>Viewpoint of this chapter</h3> <p>It is likely to become an enumeration of the code even if it nothing but reads nothing but because the specification is decided in some fullness of detail this time because the above is read from basing. Then, the target is narrowed to the following three points in this chapter. </p> <ul> <li>Serializing of loading</li> <li>Distribution of function to each file</li> <li>Mechanism of loading enhancing library</li> </ul> <p>If the actual thing is seen, the first point is understood. </p> <p>For the second pointThe function in this chapter is confused from four files of <code>eval.c ruby.c file.c dln.c</code> and appears. I will think about realistic circumstances around of that. it becomes it so why</p> <p>The third point is a read street. When the vogue is executed recent, a mechanism that loads and is plug-in so-called is seen. It wants to spare the page as a lot as possible because here is the most interesting point in this chapter and to speak. </p> <h2>Search for library</h2> <h3><code>rb_f_require()</code></h3> <p>The substance of <code>require</code> is <code>rb_f_require()</code>. First of all, let's put only the part of the file searching from among that. The argument is limited when specified without the extension because it is unpleasant when there are a lot of situation division. </p> <p class="caption">- <code>rb_f_require()</code>(abridgment version)</p> <pre class="longlist">
5527 VALUE 5528 rb_f_require(obj, fname) 5529 VALUE obj, fname; 5530 { 5531 VALUE feature, tmp; 5532 char *ext, *ftptr; /* OK */ 5533 int state; 5534 volatile int safe = ruby_safe_level; 5535 5536 SafeStringValue(fname); 5537 ext = strrchr(RSTRING(fname)-&gt;ptr, '.'); 5538 if (ext) { /*…… When the extension is specified
5584 } 5585 tmp = fname; 5586 switch (rb_find_file_ext(&amp;tmp, loadable_ext)) { 5587 case 0: 5588 break; 5589 5590 case 1: 5591 feature = fname = tmp; 5592 goto load_rb; 5593 5594 default: 5595 feature = tmp; 5596 fname = rb_find_file(tmp); 5597 goto load_dyna; 5598 } 5599 if (rb_feature_p(RSTRING(fname)-&gt;ptr, Qfalse)) 5600 return Qfalse; 5601 rb_raise(rb_eLoadError, "No such file to load -- %s", RSTRING(fname)-&gt;ptr); 5602 5603 load_dyna: /*…… The enhancing library is loaded ……*/. 5623 return Qtrue; 5624 5625 load_rb: /*…… The Ruby program is loaded ……*/. 5648 return Qtrue; 5649 } 5491 static const char *const loadable_ext[] = { 5492 ".rb", DLEXT, /* DLEXT=".so", ".dll", ".bundle"... */ 5493 #ifdef DLEXT2 5494 DLEXT2, /
* DLEXT2=".dll" on Cygwin, MinGW */ 5495 #endif 5496 0 5497 }; (eval.c)
</pre> <p>It becomes like a virtual subroutine in this function since <code>load_rb･load_dyna</code><code></code> of the <code>goto</code> label, and two variable <code>feature</code> and <code>fname</code> are existence like the argument. The variable has the following meanings. </p> <table> <tr><td>Variable<td><td>Meaning<td><td>Example<td></tr> <tr><td><code>feature</code><td><td>Library name of form put in <code>$"</code><td><td><code>uri.rb</code>､<code>nkf.so</code><td></tr> <tr><td><code>fname</code><td><td>Full path in library<td><td><code>/usr/lib/ruby/1.7/uri.rb</code><td></tr> </table> <p>The word of "feature" seems to be a general noun apparently, and the call named <code>rb_feature_p()</code> is seen. This is a function (Will see later soon) that checks whether the lock of <code>$"</code>hangs. </p> <p>Actually searching for the library : with <code>rb_find_file()</code> It is <code>rb_find_file_ext()</code>. <code>Rb_find_file()</code> looks for the file from loading passing <code>$</code>It is different to get the list of the extension (In a word, <code>loadable_ext</code>) from the second argument and to test it sequentially putting it though <code>rb_find_file_ext()</code> is also the same. </p> <p>The code of the search is seen for the time being in the following to the last minute, and after that, <code>load_rb</code> The code of the <code>require</code> lock will be seen. </p> <h3><code>rb_find_file()</code></h3> <p>It is continuation of the search first of all and <code>rb_find_file()</code>. This function looks for file <code>path</code> of the argument from global loading passing <code>$:(rb_load_path)</code><code></code>. Because it is annoying the pollution character string check or what, it makes only to the main portion and it sees. </p> <p class="caption">- <code>rb_find_file()</code>(abridgment version)</p> <pre class="longlist">
2494 VALUE 2495 rb_find_file(path) 2496 VALUE path; 2497 { 2498 VALUE tmp; 2499 char *f = RSTRING(path)-&gt;ptr; 2500 char *lpath; 2530 if (rb_load_path) { 2531 long i; 2532 2533 Check_Type(rb_load_path, T_ARRAY); 2534 tmp = rb_ary_new(); 2535 for (i=0;i&lt;RARRAY(rb_load_path)-&gt;len;i++) { 2536 VALUE str = RARRAY(rb_load_path)-&gt;ptr[i]; 2537 SafeStringValue(str); 2538 if (RSTRING(str)-&gt;len &gt; 0) { 2539 rb_ary_push(tmp, str); 2540 } 2541 } 2542 tmp = rb_ary_join(tmp, rb_str_new2(PATH_SEP)); 2543 if (RSTRING(tmp)-&gt;len == 0) { 2544 lpath = 0; 2545 } 2546 else { 2547 lpath = RSTRING(tmp)-&gt;ptr; 2551 } 2552 } 2560 f = dln_find_file(f, lpath); 2561 if (file_load_ok(f)) { 2562 return rb_str_new2(f); 2563 } 2564 return 0; 2565 } (file.c)
</pre> <p>If it is written to do with Ruby, it becomes it so. </p> <pre class="emlist">
Tmp = [] $:.each do that makes # array | path | # The loading passing is repeated. Tmp.push check(path) Push to the array checking # passing end lpath = tmp.join(PATH_SEP) # ..narrowness.. [nde] connection of PATH_SEP between elements. Dln_find_file(f, lpath) Processing
</pre> <p> <code>PATH_SEP</code> is <code>'Windows ..'</code>..<code>' in <code>path separator</code> ,in a word, UNIX;'</code>The character string that is [n] ..narrowness.. is made between elements these characters of <code>rb_ary_join()</code>. The loading passing that is the array in a word with great pains has been returned to the character string of the character district switching off. </p> <p>These kind of things might be done why. It is because it is only <code>PATH_SEP</code> delimiter row that <code>dln_find_file()</code> accepts. The reason for <code>dln.c</code> is then that it is not a library of <code>ruby</code> why <code>dln_find_file()</code> cannot help becoming such mounting. This is a general-purpose library even in case of being if it is written by the same author. When the source file was classified by the introductory chapter 'Introduction', it was divided into "Utility". A general-purpose library it is not able not to pass the Ruby object and goes because it refers to the global variable of <code>ruby</code>. </p> <p>Moreover, because this has been actually done in the part that <code>rb_find_file()</code> omitted though <code>~</code> is developed with the home directory in <code>dln_find_file()</code> It is unnecessary if it thinks only about <code>ruby</code>. </p> <h3>Loading weight</h3> <p>The file searching ends easily around here, and the following are the codes of loading. It is "Immediately before loading. " more accurate. The code of <code>load_rb</code> of <code>rb_f_require()</code> is put on the following. </p> <p class="caption">- <code>rb_f_require():load_rb</code></p> <pre class="longlist">
5625 load_rb: 5626 if (rb_feature_p(RSTRING(feature)-&gt;ptr, Qtrue)) 5627 return Qfalse; 5628 ruby_safe_level = 0; 5629 rb_provide_feature(feature); 5632 loading_tbl = St_init_strtable();
5633 } 5634 /* partial state */ 5635 ftptr = ruby_strdup(RSTRING(feature)-&
gt;ptr); 5636 st_insert(loading_tbl, ftptr, curr_thread); /*…… The Ruby program is loaded and it evaluates it ……*/. 5643 st_delete(loading_tbl, &amp;ftptr, 0); /* loading done */ 5644 free(ftptr); 5645 ruby_safe_level = safe; (eval.c)
</pre> <p><code>Rb_feature_p()</code> checks whether the lock of <code>$"</code>hangs as shown in the above-mentioned. And, <code>rb_provide_feature()</code> pushes the character string to <code>$"</code>In a word, it locks. </p> <p>The problem is the following place. It is "Loading the Ruby program is serialized. " like being in the comment. In a word, they are made to wait until loading the previous state is completed when it is possible to load only by one thread, and it tries to load the same file from other threads while loading it as for one file. If it is not so</p> <pre class="emlist">
Thread.fork { Require 'Foo'# Foo.rb is added to $"at the time of beginning of require. } # However, the thread changes while evaluating foo.rb. It returns soon because there is foo.rb in require 'Foo'#$"
# (A)The class of foo is used ……. </pre> <p>When it does very much, the code of (A) ..it not is.. might ..library <code>foo</code> still in reality.. ..loading gravel.. be executed. </p> <p>The mechanism that waiting is put is easy. <code>St_table</code> is made in global variable <code>loading_tbl</code>, and the correspondence of "Thread that <code>feature = loads &gt;</code>" is recorded. <code>Curr_thread</code> It is a variable of <code>eval.c</code>, and the value is a thread while executing it now. Because this becomes becoming exclusive lockAnd, the thread under loading waits for loading in <code>rb_feature_p()</code> until completing it as follows. </p> <p class="caption">- <code>rb_feature_p()</code>(In the latter half. )</p> <pre class="longlist">
5477 rb_thread_t th; 5478 5479 while (st_lookup(loading_tbl, f, &amp;th)) { 5480 if (th == curr_
thread) { 5481 return Qtrue; 5482 } 5483 CHECK_INTS; 5484 rb_thread_schedule(); 5485 } (eval.c)
</pre> <p>The control moves to another thread in that when <code>rb_thread_schedule()</code> is called, and it returns from the function when the control returns to me. You may end because it is loading end if the file name is lost from <code>loading_tbl</code>. The purpose of checking <code>curr_thread</code> is not to lock oneself (Figure 1). </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_load_loadwait.jpg" alt="(loadwait)"><br>Figure 1: Serializing of loading</p> <h2>Loading of Ruby program</h2> <h3><code>rb_load()</code></h3> <p>Then, this processing part of loading is seen. Among <code>load_rb</code> of <code>rb_f_require()</code> Let's start from the part where the Ruby program is loaded. </p> <p class="caption">- <code>Rb_f_require()-load_rb-</code>loading</p> <pre class="longlist">
5638 PUSH_TAG(PROT_NONE); 5639 if ((state = EXEC_TAG()) == 0) { 5640 rb_load(fname, 0); 5641 } 5642 POP_TAG(); (eval.c)
</pre> <p>Well, <code>rb_load()</code> and this is called here are actually the substance of <code>load</code> at the Ruby level. Then, the same work cannot be seen another times because the search is needed another times and it exist. Then, the part is omitted as follows. Moreover, because <code>wrap</code> of the second argument is 0 in the above-mentioned call code, it is folded in by 0. </p> <p class="caption">- <code>rb_load()</code>(abridgment version)</p> <pre class="longlist">
void rb_load(fname, /* wrap=0 */) VALUE fname; {
int state; volatile ID last_func; volatile VALUE wrapper = 0; volatile VALUE self = ruby_top_self; NODE *saved_cref = ruby_cref; PUSH_VARS(); PUSH_CLASS(); ruby_class = rb_cObject; ruby_cref = top_cref; /* (A-1) CREF is changed */. wrapper = ruby_wrapper; ruby_wrapper = 0; PUSH_FRAME(); ruby_frame-&gt;last_func = 0; ruby_frame-&gt;last_class = 0; ruby_frame-&gt;self = self; /* (A-2) ruby_frame-&gt; cbase is changed */. ruby_frame-&gt;cbase = (VALUE)rb_node_newnode(NODE_CREF,ruby_class,0,0); PUSH_SCOPE(); /* The visibility of top-level is default and private */ SCOPE_
SET(SCOPE_PRIVATE); PUSH_TAG(PROT_NONE); ruby_errinfo = Qnil; /* It surely makes to nil */. state = EXEC_TAG(); last_func = ruby_frame-&gt;last_func; if (state == 0) { NODE *node; /* (B) is treated thoroughly to eval why and */ Ruby_in_eval++;. rb_load_file(RSTRING(fname)-&gt;ptr); ruby_in_eval--; node = ruby_eval_tree; Occur.
eval_node(self, node); }
}
ruby_frame-&gt;last_func = last_func; POP_TAG(); ruby_cref = saved_cref; POP_SCOPE(); POP_FRAME(); POP_CLASS(); POP_VARS(); ruby_wrapper = wrapper; /* [pa-suera-] occurred */. ruby_nerrs = 0; rb_exc_raise(ruby_errinfo); }
if (state) jump_tag_but_local_jump(state); If (NIL_P(ruby_errinfo)) The exception was generated while loading /* */. rb_exc_raise(ruby_errinfo);
}
</pre> <p>I will read taking heart the nature though rushing into at the moment thought to be able finally to come off the storm of the stack operation also mentally has the painful one. </p> <p>Most of the code of a long function is occupied by the phrase forever. <code>PUSH/POP</code><code></code>, tag protecting, and re-jump. Wanting the to pay attention especially It is <code>CREF</code> relation of (A). Because the loaded program is always executed on top-level, <code>ruby_cref</code> (It is not a push) is saved and it returns it to <code>top_cref</code>. <code>Ruby_frame-&gt; cbase</code> is made new. </p> <p><code>Ruby_in_eval</code> is turned on by it, another place, and (B) why. This variable to begin with is <code>rb_compile_error()</code> in what integral like the function. examine whether to influence itIt becomes ..message.. output <code>stderr</code> when it is not so the preservation of the message in the exception object when <code>ruby_in_eval</code> is the truth. It seems to be a mechanism of stopping it in the evaluation machine because it is unpalatable though want to be output to <code>stderr</code> suddenly in a word by me when the main program of the command is [pa-suera-]ed. Then, It not is method <code>eval</code> and function <code>eval()</code> but a general verb of eval of <code>ruby_in_eval</code> Evaluate or <code>eval.c</code> might be indicated. </p> <h3><code>rb_load_file()</code></h3> <p>The source file suddenly moves to <code>ruby.c</code> here. so as a matter of fact will sayThat is, I want to put the file related to loading on <code>ruby.c</code> originally. However, I cannot help using the <code>PUSH_TAG()</code> etc. in <code>rb_load()</code>. Therefore, reluctantly It puts it on <code>eval.c</code>. Everything will be put from the beginning on <code>eval.c</code>. </p> <p>And, it is <code>rb_load_file()</code>. </p> <p class="caption">- <code>rb_load_file()</code></p> <pre class="longlist">
865 void 866 rb_load_file(fname) 867 char *fname; 868 { 869 load_file(fname, 0); 870 } (ruby.c)
</pre> <p>Transfer wholly. The second argument <code>script</code> of <code>load_file()</code> shows whether to load the file of the argument of the <code>ruby</code> command by the truth value. Let's be not so and see [**] with <code>script=0</code> because I want to think loading the library now. In addition, the meaning also has cut down the idea inessential in the following. </p> <p class="caption">- <code>load_file()</code>(abridgment version)</p> <pre class="longlist">
static void load_file(fname, /* script=0 */) char *fname; {
VALUE f; {
FILE *fp = fopen(fname, "r"); (A) if (fp == NULL) { rb_load_fail(fname); }
fclose(fp); }
f = rb_file_open(fname, "r"); (B) rb_compile_file(fname, f, 1); (C) rb_io_close(f);
}
</pre> <p>(A) It is whether actually opened with <code>fopen()</code> and really open are checked. If it is safe, it shuts at once. Simplicity and portability are raising certain duck's very methods though it is useless. </p> <p>(B) It opens again in library <code>File.open</code> at the Ruby level. The purpose of not opening from the beginning with <code>File.open</code> is to prevent the exception of Ruby being generated. I am embarrassed when becoming the error related to <code>open</code> , for instance, <code>Errno::ENOENT</code> or <code>Errno::EACCESS</code> or …… because I want to make now a loading error when some exceptions occur. Because here is <code>ruby.c</code>, the tag jump cannot be stopped. </p> <p>(C) The program is read from the <code>IO</code> object with [pa-sainta-feisu] <code>rb_compile_file()</code>, and it compiles to the syntax tree. Because the syntax tree is added to <code>ruby_eval_tree</code>, the result need not be received. </p> <p>The code of loading is the above. Finally, because the call was considerably deep The call graph of <code>rb_f_require()</code> or less is put. </p> <pre class="emlist">
rb_f_require ....eval.c rb_find_file ....file.c dln_find_file ....dln.c dln_find_file_1 rb_load rb_load_file ....ruby.c load_file rb_compile_file ....parse.y eval_node </pre> <p>It is a call graph in the attendant of the long journey. This is already common sense. </p> <h4>Number of <code>open</code> necessary for loading</h4> <p>Even <code>rb_find_file_ext()ing etc. </code>actually : additionally internally in the process of loading <code>ruby</code> though there was <code>open</code> used only to check whether the file opens it a little while ago <code>Open</code> is done and it checks it. It might on earth <code>open()</code> it times about how many as a whole. </p> <p>Actually counting when thinking is those who are about a correct programmer. If the system call tracer is used, it is counted easily. If it is Linux, the tool for that : Like <code>ktrace</code> or <code>truss</code>, etc. if it is <code>truss</code>, and BSD system if it is <code>strace</code>, and Solaris It must be found soon though the name is asunder in the point according to OS if it retrieves it with Google. The tracer has mostly adhered to IDE if it is Windows. </p> <p>Well, because author's main environment was Linux, it saw with <code>strace</code>. Because the output goes out to <code>stderr</code>, it redirects it by <code>two &gt; &1</code>. </p> <pre class="screen">
% strace ruby -e 'require "rational"' 2&gt;&amp;1 | grep '^open' open("/etc/ld.so.preload", O_RDONLY) = -1 ENOENT open("/etc/ld.so.
cache", O_RDONLY) = 3 open("/usr/lib/libruby-1.7.so.1.7", O_RDONLY) = 3 open("/lib/libdl.so.2", O_RDONLY) = 3 open("/lib/libcrypt.so.1", O_
RDONLY) = 3 open("/lib/libc.so.6", O_RDONLY) = 3 open("/usr/lib/ruby/1.
7/rational.rb", O_RDONLY|O_LARGEFILE) = 3 open("/usr/lib/ruby/1.7/
rational.rb", O_RDONLY|O_LARGEFILE) = 3 open("/usr/lib/ruby/1.7/
rational.rb", O_RDONLY|O_LARGEFILE) = 3 open("/usr/lib/ruby/1.7/
rational.rb", O_RDONLY|O_LARGEFILE) = 3 </pre> <p>Because even <code>open</code> of <code>libc.so.6</code> is <code>open</code> used because of mounting a dynamic link, <code>open</code> of the remainder is four times in total. In a word, it seems to be useless three times. </p> <h2>Loading of enhancing library</h2> <h3><code>rb_f_require()</code>-<code>load_dyna</code></h3> <p>Well, it is loading of the enhancing library this time. First of all <code>rb_f_require()</code> It goes from <code>load_dyna</code>. However, the code of the lock circumference was cut down because it was already unnecessary. </p> <p class="caption">- <code>rb_f_require()</code>-<code>load_dyna</code></p> <pre class="longlist">
5607 { 5608 int volatile old_vmode = scope_vmode; 5609 5610 PUSH_TAG(PROT_NONE); 5611 if ((state = EXEC_TAG()) == 0) { 5612 void *handle; 5613 5614 SCOPE_SET(SCOPE_PUBLIC); 5615 handle = dln_load(RSTRING(fname)-&gt;ptr); 5616 rb_ary_push(ruby_dln_librefs, LONG2NUM((long)handle)); 5617 } 5
618 POP_TAG(); 5619 SCOPE_SET(old_vmode); 5620 } 5621 if (state) JUMP_TAG(state); (eval.c)
</pre> <p>There is little novel thing any longer. Tag uses or doesn't probably do, and be a technique for getting used to seeing save and the return of the visibility scope the same as the phrase. It is only <code>dln_load()</code> to remain. What on earth does this do?It follows. </p> <h3>The link has been reviewed. </h3> <p>What is it loading the enhancing library because of loading of it the enhancing library of <code>dln_load()</code>?It is necessary to rewind the talk in the direction of the physical world first of all to speak it to one's heart's content, and to start from the link. </p> <p>I think that I am to say nothing of having compiled the program of C. The author If as follows is done, the moving program can be made because <code>gcc</code> is used with Linux. </p> <pre class="screen">
% gcc hello.c </pre> <p>Judging from the file name, this is Hello surely, and, World. It might be a program. Because <code>gcc</code> outputs the program to the file named <code>a.out</code> by default in UNIX, it is possible to execute it continuously as follows. </p> <pre class="screen">
% ./a.out Hello, World! </pre> <p>Neatly. can</p> <p>By the way, what did <code>gcc</code> actually do now?Actually though it is usually often said the compilation and the compilation</p> <ol> <li>[Puripurosesu](<code>cpp</code>)</li> <li>C language is compiled to the assembler. (<code>cc</code>)</li> <li>The assembler is assembled to the machine language. (<code>as</code>)</li> <li>Link(<code>ld</code>)</li> </ol> <p>It ..four stage.. goes. Only the stage of the link often ends not being made to the express statement though the explanation is looked at in various points and it multiplies by the [puripurosesu] compilation assembly among these why. Absolutely in the class of the history of the school Will it be a similar one that doesn't arrive at "Present age"?To bury the rupture, it will easily bring it together in this book then. <p>What is the program that the stage until assembling is completed?, Form..objectfile.It is such form and the major one is as follows. </p> <ul> <li>ELF, Executable and Linking Format(new UNIX)</li> <li><code>a.out</code>, assembler output(comparatively old UNIX)</li> <li>COFF, Common Object File Format(Win32)</li> </ul> <p><code>A.out</code> of the objectfile form and <code>a.out</code> of the default output file name of <code>cc</code> are different things at all though said to make sure. For instance, the ELF form can be filed if it usually makes it from Linux nowadays <code>a.out</code>. </p> <p>And, no do matter of the story how this objectfile form is different this time. Recognize it now has the idea of all these objectfiles "Sets of names". For instance, function name and variable identifier, etc. that exist in this file. </p> <p>Moreover, there are two kinds of sets of names included in the objectfile. That is,</p> <ul> <li>Sets of necessary names(For instance, foreign function that is called from inside. Example: <code>Printf</code>)</li> <li>Sets of offered names(For instance, function defined internally. Example: <code>Hello</code>)</li> </ul> <p>[Dearu]. And, the link is to confirm "Sets of necessary names" of all objectfiles is included in "Sets of offered names" when two or more objectfiles have been collected and to tie mutually. In a word all It is necessary to pull the line from "Necessary name", and to tie to "Offered name" the objectfile somewhere (Figure 2). If this is said by using the term, it becomes (resolving undefined symbol) that solves an undefined symbol. </p> <p class="image"> <img src="http://i.loveruby.net/ja/rhg/book/images/ch_load_link.jpg" alt="(link)"><br>Figure 2: Objectfile and link</p> <p>Because program doesn't actually run only by it though this logicallyThe program of C doesn't run at least. It is because it is not possible to move if the name is not converted into the address (number). </p> <p>Then, a physical uniting is needed next to a logical uniting. It is necessary to replace the objectfile and to replace all the map doing, names with the memory space of the reality by the number. The address is adjusted at the destination of the jump when the function is called to put it concretely. </p> <p>And, the link divides into two kinds when to do these two uniting. That is, it is a dynamic link to a static link. When compiling, a static link ends all stages. On the other hand, a dynamic link delays some of uniting until the program is executed. And, the link is completed only after it comes to execute the program. </p> <p>The most much having explained here is a very simple, ideal model and has respect where the reality is considerably misinterpreted. As for the logical combination and the physical binding, it is not the one that divides clearly so much, and "Objectfiles are sets of names" passes in naivete, too. However, another book can be written around of [nanishiroko] when seriously speaking because operation is too different too much because of the platform. 'Expert C programming' Further to obtain knowledge at a real level \footnote 'Expert C programming' written by Peter van der Linden, Umehara system translation, ASCII Publications Service, and 1996 You may read for written by 'Linkers&Loaders' John R.Levine, the Sakakibara tactical victory [**yaku] positive edge translation, ohm company, and 'Linkers&Loaders' @footnote2001. </p> <h3>Truly dynamic link</h3> <p>Well, let's enter the subject slowly. Naturally, "Dynamic" of a dynamic link : When actually compiling, a considerable part is decided when it is a dynamic link of usually saying though it is a meaning "When executing it, put it". For instance, the name of a necessary function might be decided, and it has already been understood whether it is in any library. For instance, because of link by feeling named <code>gcc -lm</code> because it is in <code>libm</code> if it is <code>cos()</code>When it is not specified when compiling, it becomes a link error. </p> <p>However, it is different for the enhancing library. When the name of a necessary function also compiles even the name of the linked library, it doesn't decide. It is necessary to assemble the character string while executing the program and load to link. When even "Logical combination" said in a word in a word a little while ago is all executed, it is necessary to do. A mechanism a little different again from a dynamic link of usually saying for that is needed. </p> <p>The link that decides everything at this operation ,in a word, execution usually It is called, "Dynamic loading (dynamic load)". When you go from being term [ya] in this book It is assumed, "Dynamic load" by the Chinese character because it dares to be confusing when it is a dynamic link and a dynamic loading though it is likely to have to open in "Dynamic load" and the katakana. </p> <h3>Dynamic loading API</h3> <p>The explanation of the concept is the above. Whether it is necessary to do the dynamic loading very or not?Here only has not to be difficult to say, and because special API in the system is prepared, to usually call it only. </p> <p>For instance, if it is UNIX, it is API named <code>dlopen</code> it is widely comparatively. Correctness It cannot be said, "It is in case of UNIX". For instance, a quite different interface is for a moment in previous HP-UX and when it is Mac OS X, API of the NeXT style is used. Moreover, it is the same External as <code>libdl</code> etc. when it is Linux though is in <code>libc</code> when it is BSD system will not have portability by <code>dlopen</code> by sublimeness either. Differing is also Ichi natural at all if becoming other OS because only this is different even if the floatage UNIX and ranked to the system. First of all, it is impossible that same API is used. </p> <p>To absorb the different at all interface, the file named <code>dln.c</code> is prepared why there is then <code>ruby</code>. <code>Dln</code> might be abbreviation of dynamic link. <code>Dln_load()</code> is one of the functions of the <code>dln.c</code>. <p>The one saving is that the use pattern of API is at least the same though it is quite asunder dynamic loading API in such a way quite. When it might be which platform</p> <ol> <li>The library is done and the map is done to the address space in the process. </li> <li>The pointer to the function included in the library is taken. </li> <li>It is an Ann map as for the library. </li> </ol> <p>It is composed of three stages. For instance, if it is <code>dlopen</code> system API</p> <ol> <li><code>dlopen</code></li> <li><code>dlsym</code></li> <li><code>dlclose</code></li> </ol> <p>However, it accommodates it. If it is Win32 API</p> <ol> <li><code>LoadLibrary</code>(Or, <code>LoadLibraryEx</code>. )</li> <li><code>GetProcAddress</code></li> <li><code>FreeLibrary</code></li> </ol> <p>However, it accommodates it. </p> <p>Finally, let's speak what <code>dln_load()</code> does by using this API group. This is actually a call of <code>Init_xxxx()</code>. It comes to be able finally to draw the total process from the <code>ruby</code> start to the end by arriving here without the lack. That is, <code>ruby</code> initializes the evaluation machine when starting and begins the evaluation of the main program received by some methods. On the way of that The library is loaded when <code>require</code> or <code>load</code> happens and the control is moved. It load links in case of doing Perth if it is Ruby library to move the control, the evaluation, and the enhancing library and <code>Init_xxxx()</code> is called. </p> <h3><code>dln_load()</code></h3> <p>It traced to contents of <code>dln_load()</code> and, at last, it applied it. There are this and a reason and the structure is simple though it is a function that <code>dln_load()</code> is long. I want you to see ..unpalatable.. [**katachi]. </p> <p class="caption">- <code>dln_load()</code>([**katachi])</p> <pre class="longlist">
void* dln_load(file) const char *file; {
#if defined _WIN32 &amp;&amp; !defined __CYGWIN__ It loads it with Win32 API. #else Initialization to which platform is independent
#Ifdef each platform
…… routine of each platform ……
#endif #endif #if !defined(_AIX) &amp;&amp; !defined(NeXT) failed: rb_loaderror("%s - %s", error, file); #endif return 0; /* dummy return */ }
</pre> <p>When thinking because the part that becomes a main is separate perfect in each platform like this, it only has to think only about an individual platform. Supported API is as follows. </p> <ul> <li><code>dlopen</code>(a lot of UNIX)</li> <li><code>LoadLibrary</code>(Win32)</li> <li><code>shl_load</code>(a little old HP-UX)</li> <li><code>a.out</code>(considerably old UNIX)</li> <li><code>rld_load</code><code></code>)</li> <li><code>dyld</code>(<code>NeXT</code> or Mac OS X)</li> <li><code>get_image_symbol</code>(BeOS)</li> <li><code>GetDiskFragment</code>(Mac OS 9 former)</li> <li><code>load</code>(a little old AIX)</li> </ul> <h3><code>dln_load()</code>-<code>dlopen()</code></h3> <p>First of all, let's go from the code of API of the <code>dlopen</code> system. </p> <p class="caption">- <code>dln_load()</code>-<code>dlopen()</code></p> <pre class="longlist">
1254 void* 1255 dln_load(file) 1256 const char *file; 1257 { 1259 const char *error = 0; 1260 #define DLN_ERROR() (error = dln_strerror(),\ strcpy(ALLOCA_N(char, strlen(error) + 1), error)) 1298 char *buf; 1299 /* The character string named Init_xxxx is written in buf (The area is alloca allocation) */ 1300 Init_funcname(&buf, file); 1304 { 1305 void *handle; 1306 void (*init_fct)(); 1307 1308 #ifndef RTLD_LAZY 1309 # define RTLD_LAZY 1 1310 #endif 1311 #ifndef RTLD_GLOBAL 1312 # The define RTLD_GLOBAL 0 1313 #endif 1314 1315 /* (A) library is loaded */ 1316 If ((handle = (void*)dlopen(file, RTLD_LAZY | RTLD_GLOBAL)) == NULL) { 1317 error = dln_strerror(); 1318 goto failed; 1319 } 1320 /* The pointer to (B) Init_xxxx() is taken */. 1321 init_fct = (void(*)())dlsym(handle, buf); 1322 if (init_fct == NULL) { 1323 error = DLN_ERROR(); 1324 dlclose(handle); 1325 goto failed; 1326 } 1327 /* (C) Init_xxxx() is called */. 1328 (*init_fct)(); 1329 1330 return handle; 1331 } 1576 failed: 1577 rb_loaderror("%s - %s", error, file); 1580 } (dln.c)
</pre> <p>(A) <code>RTLD_LAZY</code> of the argument of <code>dlopen()</code> shows "When the function is actually demanded, an unsettled symbol is solved". The return value should always pass this to <code>dl*()</code> by the sign (steering wheel) to identify the library. </p> <p>(B) <code>Dlsym()</code> takes the function pointer from the library that the steering wheel shows. The return value If it is <code>NULL</code>, it is a failure. The pointer to <code>Init_xxxx()</code> is taken here, and it calls. </p> <p>There is no call of <code>dlclose()</code>. Because it becomes impossible for the whole library to use <code>dlclose()</code> then, it is unpalatable though the function pointer in the library loaded in <code>Init_xxxx()</code> is sure to be returned. In a word, <code>dlclose()</code> cannot be called until the process ends. </p> <h3><code>dln_load()</code>-Win32</h3> <p><code>LoadLibrary()</code> and <code>GetProcAddress()</code> are used in Win32. It is very general Win32 API recorded in MSDN. </p> <p class="caption">- <code>dln_load()</code>-Win32</p> <pre class="longlist">
1254 void* 1255 dln_load(file) 1256 const char *file; 1257 { 1264 HINSTANCE handle; 1265 char winfile[MAXPATHLEN]; 1266 void (*init_fct)(); 1267 char *buf; 1268 1269 if (strlen(file) &gt;= MAXPATHLEN) rb_loaderror("filename too long"); 1270 1271 The character string /* "Init_xxxx" is written in buf (The area is alloca allocation) */ 1272 Init_funcname(&buf, file); 1273 1274 strcpy(winfile, file); 1275 1278 error = Dln_strerror();
1279 goto failed; 1280 } 1281 1285 1286 /* Init_xxxx() is called */. 1287 (*init_fct)(); 1288 return handle; 1576 failed: 1577 rb_loaderror("%s - %s", error, file); 1580 } (dln.c)
</pre> <p>It <code>LoadLibrary()s and </code><code>GetProcAddress()</code>. It will end because it is not said that the pattern is the same even as here. <hr> <p>The point of an opinion, an impression, and a mis-plant etc. are <a href="http://www.excite-webtl.jp/world/english/web/body/?wb_url=http%3A%2F%2Fi.loveruby.net%2Fja%2Frhg%2Fbook%2Fmailto%3Aaamine%40loveruby.net&wb_lp=JAEN&wb_dis=2">[mine**] Aoki Thank you very much even for &lt; aamine@loveruby.net &gt;</a>. </p> <p> <a href="http://www.excite-webtl.jp/world/english/web/body/?wb_url=http%3A%2F%2Fdirect.ips.co.jp%2Fdirectsys%2Fgo_x_TempChoice.cfm%3Fsh_id%3DEE0040%26amp%3Bspm_id%3D1%26amp%3BGM_ID%3D1721&wb_lp=JAEN&wb_dis=2">It is possible to reserve ..direct ..'Ruby source code complete explanation'.. IMPRESS it.. and to buy it (Fly to the book introduction page. )</a> </p> <p>Copyright (c) 2002-2004 Minero Aoki, All rights reserved.</p> </body> </html>
<script src="http://rep.excite-webtl.jp/urchin.js" type="text/javascript"></script>
<script type="text/javascript">
_udn="excite-webtl.jp";
urchinTracker();
</script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-400370-52");
pageTracker._initData();
pageTracker._trackPageview();
</script>
